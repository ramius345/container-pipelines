apiVersion: apps.openshift.io/v1
kind: DeploymentConfig
metadata:
  labels:
    app: {{ .Values.projectname }}-dev
  name: {{ .Values.projectname }}
spec:
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    deploymentconfig: {{ .Values.projectname }}
  strategy:
    activeDeadlineSeconds: 21600
    resources: {}
    rollingParams:
      intervalSeconds: 1
      maxSurge: 25%
      maxUnavailable: 25%
      timeoutSeconds: 600
      updatePeriodSeconds: 1
    type: Rolling
  template:
    metadata:
      creationTimestamp: null
      labels:
        deploymentconfig: {{ .Values.projectname }}
        app: {{ .Values.projectname }}
    spec:
      initContainers:
      - image: image-registry.openshift-image-registry.svc:5000/{{ .Release.Namespace }}/ssl-init-bc:latest
        name: jks-generator
        volumeMounts:
          - name: {{ .Values.projectname }}-tls
            mountPath: /etc/pki/tls
          - name: {{ .Values.projectname }}-tls-cabundle
            mountPath: /etc/pki/cacerts
          - mountPath: /etc/jks
            name: jks-vol
      containers:
      - image: image-registry.openshift-image-registry.svc:5000/{{ .Release.Namespace }}/{{ .Values.projectname }}:latest
        imagePullPolicy: Always
        name: {{ .Values.projectname }}
        ports:
        - containerPort: 8080
          protocol: TCP
        - containerPort: 8443
          protocol: TCP
        - containerPort: 8778
          protocol: TCP
        resources: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
          - name: {{ .Values.projectname }}-tls
            mountPath: /etc/pki/tls
            readOnly: true
          - name: {{ .Values.projectname }}-tls-cabundle
            mountPath: /etc/pki/cacerts
            readOnly: true
          - mountPath: /etc/jks
            name: jks-vol
      volumes:
        - name: {{ .Values.projectname }}-tls
          secret:
            secretName: {{ .Values.projectname }}-tls
        - name: {{ .Values.projectname }}-tls-cabundle
          configMap:
            name: {{ .Values.projectname }}-tls-cabundle
        - name: jks-vol
          emptyDir: {}

      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30

        
  test: false
  triggers:
  - type: ConfigChange
  - imageChangeParams:
      automatic: true
      containerNames:
      - {{ .Values.projectname }}
      from:
        kind: ImageStreamTag
        name: {{ .Values.projectname}}:latest
        namespace: {{ .Release.Namespace }}
    type: ImageChange
